{% extends "base_with_sidebar.html" %}

{% block title %}Server Monitoring{% endblock %}

{% block extra_css %}
<style>
    .monitoring-dashboard {
        padding: 20px;
    }
    
    .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .status-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-left: 4px solid #ddd;
        transition: all 0.3s ease;
    }
    
    .status-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    
    .status-card.healthy {
        border-left-color: #4CAF50;
    }
    
    .status-card.warning {
        border-left-color: #FFC107;
    }
    
    .status-card.error {
        border-left-color: #F44336;
    }
    
    .status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .status-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
    }
    
    .status-icon {
        font-size: 32px;
    }
    
    .status-value {
        font-size: 36px;
        font-weight: 700;
        color: #2196F3;
        margin: 10px 0;
    }
    
    .status-label {
        color: #666;
        font-size: 14px;
    }
    
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .badge-success {
        background: #E8F5E9;
        color: #4CAF50;
    }
    
    .badge-warning {
        background: #FFF3E0;
        color: #FF9800;
    }
    
    .badge-error {
        background: #FFEBEE;
        color: #F44336;
    }
    
    .progress-bar {
        width: 100%;
        height: 8px;
        background: #E0E0E0;
        border-radius: 4px;
        margin-top: 10px;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4CAF50, #8BC34A);
        border-radius: 4px;
        transition: width 0.5s ease;
    }
    
    .progress-fill.warning {
        background: linear-gradient(90deg, #FFC107, #FFD54F);
    }
    
    .progress-fill.error {
        background: linear-gradient(90deg, #F44336, #E57373);
    }
    
    .refresh-btn {
        background: #2196F3;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.3s;
    }
    
    .refresh-btn:hover {
        background: #1976D2;
    }
    
    .refresh-btn:disabled {
        background: #BDBDBD;
        cursor: not-allowed;
    }
    
    .last-update {
        color: #999;
        font-size: 13px;
        margin-top: 10px;
    }
    
    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .error-list {
        list-style: none;
        padding: 0;
        margin: 15px 0 0 0;
    }
    
    .error-item {
        background: #FFF3E0;
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 6px;
        border-left: 3px solid #FF9800;
        font-size: 13px;
        color: #E65100;
    }
    
    .metric-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .metric-row:last-child {
        border-bottom: none;
    }
    
    .metric-label {
        color: #666;
        font-size: 14px;
    }
    
    .metric-value {
        font-weight: 600;
        color: #333;
    }
    
    .auto-refresh {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .toggle-switch {
        position: relative;
        width: 50px;
        height: 24px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
        background-color: #4CAF50;
    }
    
    input:checked + .toggle-slider:before {
        transform: translateX(26px);
    }
    
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #2196F3;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="monitoring-dashboard">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>üîç Server Monitoring Dashboard</h2>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div class="auto-refresh">
                <label class="toggle-switch">
                    <input type="checkbox" id="autoRefreshToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
                <span style="font-size: 14px; color: #666;">Auto-refresh (30s)</span>
            </div>
            <button class="refresh-btn" id="refreshBtn">
                <span>üîÑ</span>
                <span>Yangilash</span>
            </button>
        </div>
    </div>
    
    <div class="last-update" id="lastUpdate">Yuklanmoqda...</div>
    
    <!-- Main Status Cards -->
    <div class="status-grid">
        <!-- Application Status -->
        <div class="status-card" id="appStatus">
            <div class="status-header">
                <div class="status-title">‚öôÔ∏è Application</div>
                <span class="status-badge badge-success" id="appBadge">Checking...</span>
            </div>
            <div class="status-value" id="appUptime">--</div>
            <div class="status-label">Uptime</div>
        </div>
        
        <!-- Database Status -->
        <div class="status-card" id="dbStatus">
            <div class="status-header">
                <div class="status-title">üíæ Database</div>
                <span class="status-badge badge-success" id="dbBadge">Checking...</span>
            </div>
            <div class="status-value" id="dbConnections">--</div>
            <div class="status-label">Active Connections</div>
        </div>
        
        <!-- CPU Usage -->
        <div class="status-card" id="cpuStatus">
            <div class="status-header">
                <div class="status-title">üíª CPU</div>
                <span class="status-value" id="cpuValue" style="font-size: 24px; margin: 0;">--%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="cpuProgress" style="width: 0%"></div>
            </div>
            <div class="status-label" style="margin-top: 5px;">Usage</div>
        </div>
        
        <!-- Memory Usage -->
        <div class="status-card" id="memStatus">
            <div class="status-header">
                <div class="status-title">üß† Memory</div>
                <span class="status-value" id="memValue" style="font-size: 24px; margin: 0;">--%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="memProgress" style="width: 0%"></div>
            </div>
            <div class="status-label" style="margin-top: 5px;">Usage</div>
        </div>
        
        <!-- Disk Usage -->
        <div class="status-card" id="diskStatus">
            <div class="status-header">
                <div class="status-title">üíø Disk</div>
                <span class="status-value" id="diskValue" style="font-size: 24px; margin: 0;">--%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="diskProgress" style="width: 0%"></div>
            </div>
            <div class="status-label" style="margin-top: 5px;">Usage</div>
        </div>
        
        <!-- Today's Sales -->
        <div class="status-card healthy">
            <div class="status-header">
                <div class="status-title">üìä Today's Sales</div>
                <span class="status-icon">üí∞</span>
            </div>
            <div class="status-value" id="todaySales">--</div>
            <div class="status-label">Total transactions</div>
        </div>
    </div>
    
    <!-- Detailed Metrics -->
    <div class="chart-container">
        <h3 style="margin-top: 0; margin-bottom: 20px;">üìà Detailed Metrics</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <div>
                <h4 style="margin-top: 0; color: #666; font-size: 14px;">System</h4>
                <div class="metric-row">
                    <span class="metric-label">Total Products</span>
                    <span class="metric-value" id="totalProducts">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Total Sales</span>
                    <span class="metric-value" id="totalSales">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Active Users</span>
                    <span class="metric-value" id="activeUsers">--</span>
                </div>
            </div>
            
            <div>
                <h4 style="margin-top: 0; color: #666; font-size: 14px;">Performance</h4>
                <div class="metric-row">
                    <span class="metric-label">Avg Response Time</span>
                    <span class="metric-value" id="avgResponseTime">-- ms</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Requests/min</span>
                    <span class="metric-value" id="requestsPerMin">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Error Rate</span>
                    <span class="metric-value" id="errorRate">--%</span>
                </div>
            </div>
            
            <div>
                <h4 style="margin-top: 0; color: #666; font-size: 14px;">Database</h4>
                <div class="metric-row">
                    <span class="metric-label">Total Size</span>
                    <span class="metric-value" id="dbSize">-- MB</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Tables</span>
                    <span class="metric-value" id="dbTables">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Avg Query Time</span>
                    <span class="metric-value" id="avgQueryTime">-- ms</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Errors -->
    <div class="chart-container" id="errorsContainer" style="display: none;">
        <h3 style="margin-top: 0; margin-bottom: 15px; color: #F44336;">‚ö†Ô∏è Recent Errors</h3>
        <ul class="error-list" id="errorsList"></ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let autoRefreshInterval = null;
let isRefreshing = false;

// Fetch monitoring data
async function fetchMonitoringData() {
    if (isRefreshing) return;
    
    isRefreshing = true;
    const refreshBtn = document.getElementById('refreshBtn');
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<span class="loading-spinner"></span><span>Yuklanmoqda...</span>';
    
    try {
        const response = await fetch('/api/monitoring-status');
        const data = await response.json();
        
        if (data.success) {
            updateDashboard(data.data);
        } else {
            console.error('Monitoring data error:', data.error);
        }
    } catch (error) {
        console.error('Failed to fetch monitoring data:', error);
    } finally {
        isRefreshing = false;
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '<span>üîÑ</span><span>Yangilash</span>';
        
        // Update last refresh time
        const now = new Date();
        document.getElementById('lastUpdate').textContent = 
            `Oxirgi yangilanish: ${now.toLocaleTimeString('uz-UZ')}`;
    }
}

// Update dashboard with data
function updateDashboard(data) {
    // Application Status
    updateStatusCard('appStatus', 'appBadge', data.application.status);
    document.getElementById('appUptime').textContent = data.application.uptime || '--';
    
    // Database Status
    updateStatusCard('dbStatus', 'dbBadge', data.database.status);
    document.getElementById('dbConnections').textContent = data.database.connections || '--';
    
    // CPU
    updateResourceCard('cpu', data.system.cpu);
    
    // Memory
    updateResourceCard('mem', data.system.memory);
    
    // Disk
    updateResourceCard('disk', data.system.disk);
    
    // Today's Sales
    document.getElementById('todaySales').textContent = data.stats.today_sales || '--';
    
    // Detailed Metrics
    document.getElementById('totalProducts').textContent = data.stats.total_products || '--';
    document.getElementById('totalSales').textContent = data.stats.total_sales || '--';
    document.getElementById('activeUsers').textContent = data.stats.active_users || '--';
    
    // Performance Metrics (mock data for now)
    document.getElementById('avgResponseTime').textContent = '45 ms';
    document.getElementById('requestsPerMin').textContent = '120';
    document.getElementById('errorRate').textContent = '0.2%';
    
    // Database Metrics
    document.getElementById('dbSize').textContent = data.database.size || '--';
    document.getElementById('dbTables').textContent = data.database.tables || '--';
    document.getElementById('avgQueryTime').textContent = '12 ms';
    
    // Errors
    if (data.errors && data.errors.length > 0) {
        document.getElementById('errorsContainer').style.display = 'block';
        const errorsList = document.getElementById('errorsList');
        errorsList.innerHTML = data.errors.map(err => 
            `<li class="error-item">${err}</li>`
        ).join('');
    } else {
        document.getElementById('errorsContainer').style.display = 'none';
    }
}

// Update status card
function updateStatusCard(cardId, badgeId, status) {
    const card = document.getElementById(cardId);
    const badge = document.getElementById(badgeId);
    
    card.className = 'status-card';
    
    if (status === 'healthy' || status === 'connected') {
        card.classList.add('healthy');
        badge.className = 'status-badge badge-success';
        badge.textContent = status === 'connected' ? 'Connected' : 'Healthy';
    } else if (status === 'warning') {
        card.classList.add('warning');
        badge.className = 'status-badge badge-warning';
        badge.textContent = 'Warning';
    } else {
        card.classList.add('error');
        badge.className = 'status-badge badge-error';
        badge.textContent = 'Error';
    }
}

// Update resource card (CPU, Memory, Disk)
function updateResourceCard(prefix, data) {
    const value = parseFloat(data.percent) || 0;
    const valueElement = document.getElementById(`${prefix}Value`);
    const progressElement = document.getElementById(`${prefix}Progress`);
    const statusCard = document.getElementById(`${prefix}Status`);
    
    valueElement.textContent = `${value.toFixed(1)}%`;
    progressElement.style.width = `${value}%`;
    
    // Update progress bar color and card status
    statusCard.className = 'status-card';
    progressElement.className = 'progress-fill';
    
    if (value > 90) {
        statusCard.classList.add('error');
        progressElement.classList.add('error');
    } else if (value > 75) {
        statusCard.classList.add('warning');
        progressElement.classList.add('warning');
    } else {
        statusCard.classList.add('healthy');
    }
}

// Auto-refresh toggle
document.getElementById('autoRefreshToggle').addEventListener('change', function(e) {
    if (e.target.checked) {
        startAutoRefresh();
    } else {
        stopAutoRefresh();
    }
});

function startAutoRefresh() {
    stopAutoRefresh(); // Clear any existing interval
    autoRefreshInterval = setInterval(fetchMonitoringData, 30000); // 30 seconds
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// Manual refresh button
document.getElementById('refreshBtn').addEventListener('click', fetchMonitoringData);

// Initial load
fetchMonitoringData();
startAutoRefresh();
</script>
{% endblock %}
