{% extends "base.html" %}

{% block head %}
{{ super() }}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block extra_css %}
<style>
.store-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin: 20px 0;
}

.store-card {
    width: 100%;
    height: 350px;
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #e74c3c;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.store-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

    .store-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .store-name {
        font-size: 1.4rem;
        font-weight: bold;
        color: #2c3e50;
    }

    .store-status {
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .status-good { background: #d5e8d4; color: #2e7d32; }
    .status-medium { background: #fff3cd; color: #856404; }
    .status-low { background: #f8d7da; color: #721c24; }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: #ecf0f1;
        border-radius: 4px;
        overflow: hidden;
        margin: 0.5rem 0;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #27ae60, #2ecc71);
        transition: width 0.3s ease;
    }

    .progress-fill.medium { background: linear-gradient(90deg, #f39c12, #e67e22); }
    .progress-fill.low { background: linear-gradient(90deg, #e74c3c, #c0392b); }

    .store-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin: 1rem 0;
    }

    .info-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #7f8c8d;
        font-size: 0.9rem;
    }

    .store-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        justify-content: space-between;
    }

    .btn-small {
        padding: 0.5rem 0.8rem;
        font-size: 0.85rem;
        border-radius: 4px;
        text-decoration: none;
        transition: all 0.3s ease;
        flex: 1;
        text-align: center;
        border: none;
        cursor: pointer;
    }

    .btn-view {
        background: #3498db;
        color: white;
    }

    .btn-view:hover {
        background: #2980b9;
        transform: translateY(-1px);
    }

    .btn-edit {
        background: #f39c12;
        color: white;
    }

    .btn-edit:hover {
        background: #e67e22;
        transform: translateY(-1px);
    }

    .btn-delete {
        background: #e74c3c;
        color: white;
    }

    .btn-delete:hover {
        background: #c0392b;
        transform: translateY(-1px);
    }

    /* Modal Styles */
    .delete-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .delete-modal.active {
        display: flex;
    }

    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        color: #e74c3c;
    }

    .modal-header i {
        font-size: 2rem;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.5rem;
    }

    .modal-body {
        margin-bottom: 20px;
    }

    .modal-body p {
        margin: 10px 0;
        color: #555;
        line-height: 1.6;
    }

    .modal-body .store-name-highlight {
        font-weight: bold;
        color: #e74c3c;
        font-size: 1.1rem;
        padding: 5px 10px;
        background: #fee;
        border-radius: 4px;
        display: inline-block;
        margin: 10px 0;
    }

    .modal-input-group {
        margin: 20px 0;
    }

    .modal-input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #333;
    }

    .modal-input-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.3s;
    }

    .modal-input-group input:focus {
        outline: none;
        border-color: #3498db;
    }

    .modal-input-group input.error {
        border-color: #e74c3c;
    }

    .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .modal-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
    }

    .modal-btn-cancel {
        background: #95a5a6;
        color: white;
    }

    .modal-btn-cancel:hover {
        background: #7f8c8d;
    }

    .modal-btn-delete {
        background: #e74c3c;
        color: white;
        opacity: 0.5;
        cursor: not-allowed;
    }

    .modal-btn-delete.enabled {
        opacity: 1;
        cursor: pointer;
    }

    .modal-btn-delete.enabled:hover {
        background: #c0392b;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
    }

    /* RESPONSIVE DESIGN - BIR QATORDA 3 TA */
    @media (max-width: 1200px) {
        .store-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .store-grid {
            grid-template-columns: 1fr;
        }
    }

    /* MUTLAQ O'ZGARMAS QOIDALAR */
    * {
        box-sizing: border-box;
    }
</style>
{% endblock %}

{% block content %}
<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="delete-modal">
    <div class="modal-content">
        <div class="modal-header">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>DIQQAT! Do'konni o'chirish</h3>
        </div>
        <div class="modal-body">
            <p><strong>Siz quyidagi do'konni o'chirmoqchisiz:</strong></p>
            <div class="store-name-highlight" id="modalStoreName"></div>
            <p style="color: #e74c3c; font-weight: bold;">‚ö†Ô∏è Bu amal qaytarib bo'lmaydi!</p>
            <p>Davom etish uchun do'kon nomini quyidagi maydonga kiriting:</p>
            
            <div class="modal-input-group">
                <label for="confirmInput">Do'kon nomi:</label>
                <input 
                    type="text" 
                    id="confirmInput" 
                    placeholder="Do'kon nomini kiriting..."
                    autocomplete="off"
                >
            </div>
        </div>
        <div class="modal-actions">
            <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">
                ‚ùå Bekor qilish
            </button>
            <button class="modal-btn modal-btn-delete" id="confirmDeleteBtn" disabled>
                üóëÔ∏è O'chirish
            </button>
        </div>
    </div>
</div>

<!-- Content Header -->
<div class="content-header" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h1>üè¨ Do'konlar boshqaruvi</h1>
        <div class="breadcrumb">Dokon boshqaruvi / Do'konlar</div>
    </div>
    <a href="/add_store" class="btn btn-success" style="padding: 0.6rem 1.5rem; font-size: 0.9rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.3s; font-weight: 500;">
        ‚ûï Yangi do'kon qo'shish
    </a>
</div>

<!-- Stores Grid -->
<div class="store-grid">
    {% for store in stores %}
    <div class="store-card" data-store-id="{{ store.id }}">
        <div class="store-header">
            <div class="store-name">{{ store.name }}</div>
        </div>

        <div class="store-info">
            <div class="info-item">
                <span>üìç</span>
                <span>{{ store.address[:30] }}{% if store.address|length > 30 %}...{% endif %}</span>
            </div>
            <div class="info-item">
                <span>üë§</span>
                <span>{{ store.manager_name }}</span>
            </div>
            <div class="info-item">
                <span>üìû</span>
                <span>{{ store.phone or 'Telefon yo\'q' }}</span>
            </div>
            <div class="info-item">
                <span>üìÖ</span>
                <span>{{ store.created_date.strftime('%d.%m.%Y') if store.created_date else 'Noma\'lum' }}</span>
            </div>
        </div>

        <div class="store-actions">
            <a href="/store/{{ store.id }}" class="btn-small btn-view">
                üëÅÔ∏è Ko'rish
            </a>
            <a href="/edit_store/{{ store.id }}" class="btn-small btn-edit">
                ‚úèÔ∏è Tahrirlash
            </a>
            <button data-store-id="{{ store.id }}" 
                    data-store-name="{{ store.name }}"
                    onclick="deleteStore('{{ store.id }}', '{{ store.name }}')" 
                    class="btn-small btn-delete">
                üóëÔ∏è O'chirish
            </button>
        </div>
    </div>
    {% else %}
    <div class="store-card" style="grid-column: 1 / -1; text-align: center;">
        <h3>Do'konlar topilmadi</h3>
        <p style="color: #7f8c8d; margin: 1rem 0;">Hali do'konlar qo'shilmagan. Birinchi do'konni qo'shing!</p>
        <a href="/add_store" class="btn btn-success">
            ‚ûï Birinchi do'konni qo'shish
        </a>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Sidebar active link
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Do\'konlar sahifasi yuklandi');
    });

    // Modal variables
    let currentStoreId = null;
    let currentStoreName = null;

    // Open delete modal
    function deleteStore(storeId, storeName) {
        console.log('üéØ YANGI deleteStore FUNKSIYASI CHAQIRILDI!');
        console.log('O\'chirish funksiyasi chaqirildi:', storeId, storeName);
        
        currentStoreId = storeId;
        currentStoreName = storeName;
        
        // Modal ochish
        const modal = document.getElementById('deleteModal');
        const modalStoreName = document.getElementById('modalStoreName');
        const confirmInput = document.getElementById('confirmInput');
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        
        if (!modal) {
            console.error('‚ùå Modal topilmadi!');
            alert('Xatolik: Modal oyna topilmadi!');
            return;
        }
        
        modalStoreName.textContent = storeName;
        confirmInput.value = '';
        confirmBtn.disabled = true;
        confirmBtn.classList.remove('enabled');
        
        modal.classList.add('active');
        console.log('‚úÖ Modal ochildi, active class qo\'shildi');
        
        // Input'ga fokus
        setTimeout(() => confirmInput.focus(), 300);
    }

    // Close delete modal
    function closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        modal.classList.remove('active');
        currentStoreId = null;
        currentStoreName = null;
    }

    // Input validation - real-time
    document.addEventListener('DOMContentLoaded', function() {
        const confirmInput = document.getElementById('confirmInput');
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        
        if (!confirmInput || !confirmBtn) return;
        
        confirmInput.addEventListener('input', function() {
            const inputValue = this.value.trim();
            
            if (inputValue === currentStoreName) {
                confirmBtn.disabled = false;
                confirmBtn.classList.add('enabled');
                this.classList.remove('error');
            } else {
                confirmBtn.disabled = true;
                confirmBtn.classList.remove('enabled');
                if (inputValue.length > 0) {
                    this.classList.add('error');
                } else {
                    this.classList.remove('error');
                }
            }
        });
        
        // Enter tugmasini bosish
        confirmInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !confirmBtn.disabled) {
                confirmDeleteStore();
            }
        });
        
        // Modal tashqarisiga bosish
        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });
        
        // Confirm delete button click
        confirmBtn.addEventListener('click', confirmDeleteStore);
    });

    // Confirm delete store
    function confirmDeleteStore() {
        if (!currentStoreId) return;
        
        console.log('Tasdiqlandi! O\'chirish boshlandi:', currentStoreId);
        
        // Tugmani o'chirish
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        confirmBtn.disabled = true;
        confirmBtn.textContent = '‚è≥ O\'chirilmoqda...';
        
        fetch(`/api/store/${currentStoreId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            console.log('API javob olindi:', response.status, response.statusText);
            return response.json().then(data => {
                if (response.ok) {
                    console.log('Muvaffaqiyat! Sahifa qayta yuklanmoqda...');
                    closeDeleteModal();
                    window.location.reload();
                } else {
                    console.error('API xatosi:', response.status, data);
                    alert('Xatolik: ' + (data.error || data.message || 'Do\'konni o\'chirib bo\'lmadi'));
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'üóëÔ∏è O\'chirish';
                }
            });
        })
        .catch(error => {
            console.error('Fetch xatosi:', error);
            alert('Aloqa xatosi! Qaytadan urinib ko\'ring.');
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'üóëÔ∏è O\'chirish';
        });
    }

    function toggleStore(storeId, isActive) {
        // API ga so'rov yuborish
        fetch(`/api/store/${storeId}/toggle`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                is_active: isActive
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Store toggle response:', data);
            if (data.success) {
                window.location.reload();
            } else {
                alert('Xatolik: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Toggle xatosi:', error);
            alert('Aloqa xatosi!');
        });
    }

</script>
{% endblock %}
